<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Crypto Simulator - Exchange</title>
  <link rel="icon" href="logo.png" type="image/png" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1c1c3a, #12122b);
      color: #eee;
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
    }
    main {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      text-align: center;
      max-width: 500px;
      margin: 140px auto 40px;
      padding: 40px;
      background: #2a2a4fdd;
      border-radius: 20px;
      box-shadow: 0 0 30px rgba(187, 134, 252, 0.8);
      backdrop-filter: blur(12px);
      position: relative;
      z-index: 2;
    }
    h1 {
      font-size: 2.5rem;
      color: #bb86fc;
      margin-bottom: 20px;
    }
    label, select, input, button {
      font-size: 1rem;
      margin: 10px 0;
      padding: 10px;
      border-radius: 8px;
      border: none;
      width: 100%;
    }
    select, input {
      background: #3a3a6a;
      color: #eee;
    }
    button {
      background: #bb86fc;
      color: #12122b;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover {
      background: #a678f0;
    }
    #bubble-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      z-index: 1;
    }
  </style>
</head>
<body>
  <canvas id="bubble-canvas"></canvas>
  
  <!-- NAVBAR -->
  <!-- Copiata da dashboard, esattamente identica -->
  <nav class="navbar">
    <div class="nav-container">
      <a href="dashboard.html" class="logo-link" aria-label="Logo CryptoSim">
        <img src="logo.png" alt="CryptoSim Logo" />
      </a>
      <div id="nav-toggle" aria-label="Apri menu" role="button" tabindex="0" aria-expanded="false">
        <span></span><span></span><span></span>
      </div>
      <ul class="nav-menu" id="nav-menu">
        <li><a href="dashboard.html">Home</a></li>
        <li><a href="exchange.html">Exchange</a></li>
        <li><a href="vouch-create.html">Vouch Create</a></li>
        <li><a href="vouch-redeem.html">Vouch Redeem</a></li>
        <li><a href="afk.html">AFK Zone</a></li>
        <li><a href="account.html">Account</a></li>
        <li><button id="theme-toggle">üåô</button></li>
      </ul>
    </div>
  </nav>

  <main>
    <h1>Exchange</h1>
    <label for="from">Da:</label>
    <select id="from">
      <option value="BTC">Bitcoin (BTC)</option>
      <option value="ETH">Ethereum (ETH)</option>
      <option value="LTC">Litecoin (LTC)</option>
    </select>
    <label for="to">A:</label>
    <select id="to">
      <option value="BTC">Bitcoin (BTC)</option>
      <option value="ETH">Ethereum (ETH)</option>
      <option value="LTC">Litecoin (LTC)</option>
    </select>
    <label for="amount">Importo da scambiare:</label>
    <input type="number" id="amount" step="0.001" min="0.001" />
    <button id="exchange-btn">Scambia</button>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const app = initializeApp({
      apiKey: "AIzaSyA63kHy6QyUQteu6Vqja3c6wZOM2-h9tRQ",
      authDomain: "coins-7104d.firebaseapp.com",
      databaseURL: "https://coins-7104d-default-rtdb.firebaseio.com",
      projectId: "coins-7104d",
      storageBucket: "coins-7104d.appspot.com",
      messagingSenderId: "893938643778",
      appId: "1:893938643778:web:30cdef9cfbc2776c77cedb"
    });

    const db = getDatabase(app);
    const user = localStorage.getItem('user');
    if (!user) {
      window.location.href = "index.html";
    }

    const rates = {
      BTC: { ETH: 15, LTC: 100 },
      ETH: { BTC: 1/15, LTC: 6.7 },
      LTC: { BTC: 1/100, ETH: 1/6.7 }
    };

    document.getElementById('exchange-btn').addEventListener('click', async () => {
      const from = document.getElementById('from').value;
      const to = document.getElementById('to').value;
      const amount = parseFloat(document.getElementById('amount').value);

      if (from === to || isNaN(amount) || amount <= 0) {
        alert("Operazione non valida");
        return;
      }

      const userRef = ref(db, `users/${user}/wallet`);
      const snapshot = await get(userRef);
      const wallet = snapshot.val() || {};

      if ((wallet[from] || 0) < amount) {
        alert("Fondi insufficienti");
        return;
      }

      const exchanged = amount * rates[from][to];
      wallet[from] -= amount;
      wallet[to] = (wallet[to] || 0) + exchanged;

      await update(userRef, wallet);
      alert(`Scambiati ${amount.toFixed(3)} ${from} in ${exchanged.toFixed(3)} ${to}`);
      document.getElementById('amount').value = '';
    });

    // NAVBAR hamburger
    const navToggle = document.getElementById('nav-toggle');
    const navMenu = document.getElementById('nav-menu');
    function toggleMenu() {
      navToggle.classList.toggle('open');
      navMenu.classList.toggle('open');
    }
    navToggle.addEventListener('click', toggleMenu);

    // THEME toggle
    const themeBtn = document.getElementById('theme-toggle');
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'light') {
      document.body.classList.add('light-theme');
      themeBtn.textContent = '‚òÄÔ∏è';
    }
    themeBtn.addEventListener('click', () => {
      if (document.body.classList.toggle('light-theme')) {
        localStorage.setItem('theme', 'light');
        themeBtn.textContent = '‚òÄÔ∏è';
      } else {
        localStorage.setItem('theme', 'dark');
        themeBtn.textContent = 'üåô';
      }
    });

    // CANVAS BUBBLES
    const canvas = document.getElementById('bubble-canvas');
    const ctx = canvas.getContext('2d');
    let width, height, bubbles = [];

    class Bubble {
      constructor() { this.reset(); }
      reset() {
        this.x = Math.random() * width;
        this.y = height + Math.random() * 100;
        this.radius = 8 + Math.random() * 12;
        this.speed = 0.5 + Math.random() * 1.5;
        this.alpha = 0.1 + Math.random() * 0.3;
        this.phase = Math.random() * 2 * Math.PI;
        this.amplitude = 15 + Math.random() * 15;
      }
      update() {
        this.y -= this.speed;
        this.x += Math.sin(this.phase) * 0.3;
        this.phase += 0.03;
        if (this.y + this.radius < 0) this.reset();
      }
      draw() {
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.radius, 0, 2 * Math.PI);
        const grad = ctx.createRadialGradient(this.x, this.y, this.radius * 0.2, this.x, this.y, this.radius);
        grad.addColorStop(0, `rgba(187,134,252,${this.alpha})`);
        grad.addColorStop(1, 'rgba(187,134,252,0)');
        ctx.fillStyle = grad;
        ctx.fill();
      }
    }

    function resize() {
      width = window.innerWidth;
      height = window.innerHeight;
      canvas.width = width;
      canvas.height = height;
    }
    function animate() {
      ctx.clearRect(0, 0, width, height);
      for (let b of bubbles) {
        b.update();
        b.draw();
      }
      requestAnimationFrame(animate);
    }
    function init() {
      resize();
      bubbles = Array.from({ length: 50 }, () => new Bubble());
      animate();
    }
    window.addEventListener('resize', resize);
    init();
  </script>
</body>
</html>
