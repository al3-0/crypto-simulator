<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Crypto Simulator - Registrazione</title>
<link rel="stylesheet" href="css/style.css" />
<style>
  /* Stile simile a login con sfumatura diversa */
  body {
    background: linear-gradient(135deg, #2b2b4f, #161630);
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #eee;
  }
  main {
    background: #3b3b6a;
    padding: 40px 30px;
    border-radius: 12px;
    box-shadow: 0 0 20px rgba(187, 134, 252, 0.8);
    width: 380px;
  }
  h1 {
    margin-bottom: 24px;
    font-weight: 700;
    text-align: center;
    color: #bb86fc;
  }
  form {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }
  input {
    padding: 12px 14px;
    border-radius: 8px;
    border: none;
    font-size: 1rem;
    background: #4b4b87;
    color: #f0f0f0;
    transition: background 0.3s ease;
  }
  input:focus {
    background: #7a68e2;
    outline: none;
  }
  button {
    padding: 12px;
    border: none;
    border-radius: 8px;
    background-color: #bb86fc;
    color: #1a1a2e;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background-color: #9a68e2;
  }
  p.login-link {
    margin-top: 18px;
    font-size: 0.9rem;
    text-align: center;
    color: #ccc;
  }
  p.login-link a {
    color: #7e5fff;
    text-decoration: none;
    font-weight: 600;
    cursor: pointer;
  }
  p.login-link a:hover {
    text-decoration: underline;
  }
</style>

<script src="https://www.google.com/recaptcha/api.js?render=6LfTk5IrAAAAAJ2nd3NtRSy8_kJMJb7d_g4mFQoU"></script>

<script type="module">
  import { db, ref, get, set } from './js/firebase.js';

  async function getIP() {
    try {
      const res = await fetch('https://api.ipify.org?format=json');
      const data = await res.json();
      return data.ip;
    } catch {
      return '0.0.0.0';
    }
  }

  async function executeRecaptcha() {
    return grecaptcha.execute('6LfTk5IrAAAAAJ2nd3NtRSy8_kJMJb7d_g4mFQoU', {action: 'register'});
  }

  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById('register-form');

    form.addEventListener('submit', async e => {
      e.preventDefault();

      const username = form.username.value.trim();
      const password = form.password.value;
      const passwordConfirm = form.passwordConfirm.value;

      // Basic validation
      if (!username.match(/^[a-zA-Z0-9]{3,15}$/)) {
        alert("Username deve essere 3-15 caratteri, solo lettere e numeri.");
        return;
      }
      if (password.length < 6) {
        alert("La password deve contenere almeno 6 caratteri.");
        return;
      }
      if (password !== passwordConfirm) {
        alert("Le password non corrispondono.");
        return;
      }

      try {
        const token = await executeRecaptcha();
        if (!token) {
          alert("Errore nella verifica reCAPTCHA, riprova.");
          return;
        }

        // Verifica se utente esiste già
        const snapshot = await get(ref(db, `users/${username}`));
        if (snapshot.exists()) {
          alert("Username già utilizzato, scegli un altro.");
          return;
        }

        const ip = await getIP();

        await set(ref(db, `users/${username}`), {
          password,
          createdAt: new Date().toISOString(),
          ip,
          balance: 0
        });

        alert("Registrazione completata! Ora puoi effettuare il login.");
        window.location.href = "login.html";

      } catch (error) {
        alert("Errore di connessione o server, riprova.");
        console.error(error);
      }
    });
  });
</script>
</head>
<body>
  <main role="main" aria-label="Registrazione Crypto Simulator">
    <h1>Crypto Simulator</h1>
    <form id="register-form" novalidate>
      <input type="text" name="username" placeholder="Username (3-15 caratteri)" required minlength="3" maxlength="15" pattern="[a-zA-Z0-9]+" title="Solo lettere e numeri" autocomplete="username" />
      <input type="password" name="password" placeholder="Password (min 6 caratteri)" required minlength="6" autocomplete="new-password" />
      <input type="password" name="passwordConfirm" placeholder="Conferma Password" required minlength="6" autocomplete="new-password" />
      <button type="submit" aria-label="Registrati">Registrati</button>
    </form>
    <p class="login-link">
      Hai già un account? <a href="login.html">Accedi qui!</a>
    </p>
  </main>
</body>
</html>
