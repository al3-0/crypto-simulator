<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AFK Zone</title>
  <link rel="icon" href="logo.png" type="image/png" />
  <style>
    /* ---- BASE ---- */
    body {
      margin: 0;
      padding: 100px 20px 20px;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to bottom right, #1b1b2f, #16213e);
      color: #fff;
      overflow-x: hidden;
      position: relative;
      transition: background 0.3s ease;
    }

    main {
      text-align: center;
      max-width: 600px;
      margin: auto;
      background: #22254b;
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 0 25px rgba(187,134,252,0.3);
      z-index: 2;
      position: relative;
      animation: fadeIn 1s ease;
    }

    h1 {
      font-size: 2.2rem;
      margin-bottom: 20px;
      color: #bb86fc;
    }

    #timer {
      font-size: 2.4rem;
      font-weight: bold;
      margin: 20px 0;
    }

    #btc-earned {
      font-size: 1.5rem;
      color: #ffd700;
      margin-bottom: 30px;
    }

    canvas#bubbles {
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
    }

    .drop {
      position: absolute;
      width: 40px;
      height: 40px;
      background: radial-gradient(circle at center, #4fc3f7, #0288d1);
      border-radius: 50%;
      z-index: 99;
      animation: fall 5s linear forwards;
      cursor: pointer;
    }

    #btc-display {
      font-family: monospace;
      font-size: 1.3rem;
      color: #90caf9;
    }

    /* Animazioni */
    @keyframes fall {
      from { top: -50px; }
      to { top: 100vh; opacity: 0; }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Light theme */
    body.light-theme {
      background: #f9f9f9;
      color: #111;
    }

    body.light-theme main {
      background: #fff;
      color: #222;
      box-shadow: 0 0 25px rgba(0,0,0,0.1);
    }

    /* NAVBAR (copiata da dashboard) */
    nav.navbar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: #1c1c3a;
      box-shadow: 0 2px 8px rgba(0,0,0,0.8);
      z-index: 10;
    }

    .nav-container {
      max-width: 1200px;
      margin: auto;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
    }

    .logo-link img {
      height: 36px;
    }

    .nav-menu {
      list-style: none;
      display: flex;
      gap: 24px;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
    }

    .nav-menu li a, #theme-toggle {
      color: #ddd;
      font-weight: bold;
      text-decoration: none;
      padding: 8px 12px;
      border-radius: 6px;
      transition: background 0.3s ease;
    }

    .nav-menu li a:hover, #theme-toggle:hover {
      background: #4b3ca7;
      color: white;
    }
  </style>
</head>
<body>
  <canvas id="bubbles"></canvas>

  <!-- NAVBAR -->
  <nav class="navbar">
    <div class="nav-container">
      <a href="dashboard.html" class="logo-link"><img src="logo.png" alt="Logo"></a>
      <ul class="nav-menu">
        <li><a href="dashboard.html">Home</a></li>
        <li><a href="exchange.html">Exchange</a></li>
        <li><a href="vouch-create.html">Vouch Create</a></li>
        <li><a href="vouch-redeem.html">Vouch Redeem</a></li>
        <li><a href="afk.html">AFK Zone</a></li>
        <li><a href="account.html">Account</a></li>
        <li><button id="theme-toggle">ðŸŒ™</button></li>
      </ul>
    </div>
  </nav>

  <main>
    <h1>AFK Timer</h1>
    <div id="timer">60</div>
    <div id="btc-earned">BTC Totali: <span id="btc-display">0.000</span></div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getDatabase,
      ref,
      onValue,
      update
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA63kHy6QyUQteu6Vqja3c6wZOM2-h9tRQ",
      authDomain: "coins-7104d.firebaseapp.com",
      databaseURL: "https://coins-7104d-default-rtdb.firebaseio.com",
      projectId: "coins-7104d",
      storageBucket: "coins-7104d.appspot.com",
      messagingSenderId: "893938643778",
      appId: "1:893938643778:web:30cdef9cfbc2776c77cedb"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const username = localStorage.getItem('user');
    if (!username) window.location.href = "index.html";

    let btcTotal = 0;
    let seconds = 60;
    let interval = null;
    let tabActive = true;

    const timerEl = document.getElementById("timer");
    const btcDisplay = document.getElementById("btc-display");

    document.addEventListener("visibilitychange", () => {
      tabActive = !document.hidden;
      if (tabActive && !interval) startTimer();
      else if (!tabActive && interval) stopTimer();
    });

    function startTimer() {
      interval = setInterval(() => {
        seconds--;
        timerEl.textContent = seconds;

        if (seconds <= 0) {
          const reward = (Math.random() * 0.001).toFixed(6);
          btcTotal += parseFloat(reward);
          btcDisplay.textContent = btcTotal.toFixed(6);
          update(ref(db, `users/${username}/wallet`), {
            BTC: btcTotal
          });
          seconds = 60;
        }
      }, 1000);
    }

    function stopTimer() {
      clearInterval(interval);
      interval = null;
    }

    // Gocce interattive
    setInterval(() => {
      if (!tabActive) return;
      if (document.querySelectorAll(".drop").length >= 10) return;

      const drop = document.createElement("div");
      drop.classList.add("drop");
      drop.style.left = Math.random() * (window.innerWidth - 40) + "px";
      document.body.appendChild(drop);

      drop.addEventListener("click", () => {
        seconds = Math.max(0, seconds - 5);
        drop.remove();
      });

      setTimeout(() => drop.remove(), 6000);
    }, 6000);

    // Bubbles canvas
    const canvas = document.getElementById("bubbles");
    const ctx = canvas.getContext("2d");
    canvas.width = innerWidth;
    canvas.height = innerHeight;
    let bubbles = [];

    class Bubble {
      constructor() {
        this.x = Math.random() * canvas.width;
        this.y = canvas.height + 50;
        this.r = 5 + Math.random() * 8;
        this.speed = 1 + Math.random() * 1.5;
      }
      update() {
        this.y -= this.speed;
        if (this.y + this.r < 0) this.y = canvas.height + 50;
      }
      draw() {
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.r, 0, 2 * Math.PI);
        ctx.fillStyle = "rgba(187,134,252,0.3)";
        ctx.fill();
      }
    }

    function animate() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      for (const b of bubbles) {
        b.update();
        b.draw();
      }
      requestAnimationFrame(animate);
    }

    for (let i = 0; i < 30; i++) bubbles.push(new Bubble());
    animate();

    // Tema
    const themeBtn = document.getElementById("theme-toggle");
    const saved = localStorage.getItem("theme");
    if (saved === "light") {
      document.body.classList.add("light-theme");
      themeBtn.textContent = "â˜€ï¸";
    }
    themeBtn.addEventListener("click", () => {
      const isLight = document.body.classList.toggle("light-theme");
      localStorage.setItem("theme", isLight ? "light" : "dark");
      themeBtn.textContent = isLight ? "â˜€ï¸" : "ðŸŒ™";
    });

    // Avvio
    onValue(ref(db, `users/${username}/wallet/BTC`), (snap) => {
      const val = snap.val() || 0;
      btcTotal = parseFloat(val);
      btcDisplay.textContent = btcTotal.toFixed(6);
    });

    startTimer();
  </script>
</body>
</html>
