<script type="module">
import { db, ref, get, update } from './js/firebase.js';

let btc = 0;
let timer = null;
let countdownTimer = null;
let secondsLeft = 60;

const username = localStorage.getItem("user");
const counterEl = document.getElementById('btcEarned');
const statusEl = document.getElementById('afkStatus');
const listEl = document.getElementById('sessionList');
const countdownEl = document.getElementById('countdown');

function updateCountdown() {
  countdownEl.textContent = secondsLeft;
}

function startCountdown() {
  if (countdownTimer) clearInterval(countdownTimer);
  secondsLeft = 60;
  updateCountdown();

  countdownTimer = setInterval(() => {
    secondsLeft--;
    updateCountdown();

    if (secondsLeft <= 0) {
      addReward();
      secondsLeft = 60;
    }
  }, 1000);
}

function stopCountdown() {
  if (countdownTimer) clearInterval(countdownTimer);
}

async function addReward() {
  if (!username) return;

  btc += 0.001;
  counterEl.textContent = `+${btc.toFixed(3)} BTC`;

  const li = document.createElement('li');
  const now = new Date().toLocaleTimeString();
  li.textContent = `${now} – Guadagnato 0.001 BTC`;
  listEl.prepend(li);

  try {
    const userRef = ref(db, `users/${username}`);
    const snapshot = await get(userRef);
    if (!snapshot.exists()) return;

    const current = snapshot.val();
    const newWallet = (parseFloat(current.wallet) || 0) + 0.001;

    await update(userRef, { wallet: newWallet.toFixed(8) });
  } catch (error) {
    console.error("Errore aggiornamento wallet:", error);
  }
}

function startAFK() {
  if (!timer) {
    startCountdown();
    statusEl.textContent = '✅ Guadagno attivo';
  }
}

function stopAFK() {
  stopCountdown();
  timer = null;
  statusEl.textContent = '⛔ Guadagno in pausa (scheda non attiva)';
}

document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible') {
    startAFK();
  } else {
    stopAFK();
  }
});

window.addEventListener('load', () => {
  if (document.visibilityState === 'visible') {
    startAFK();
  }
});
</script>
