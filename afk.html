<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AFK Zone - Crypto Simulator</title>
  <link rel="icon" href="logo.png" type="image/png" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #1a1a2e;
      color: #eee;
      overflow-x: hidden;
      min-height: 100vh;
      position: relative;
    }
    canvas {
      position: fixed;
      top: 0;
      left: 0;
      pointer-events: none;
      z-index: 1;
    }
    #drop-canvas {
      pointer-events: auto;
      z-index: 3;
    }
    nav.navbar {
      background: rgba(30, 30, 60, 0.85);
      backdrop-filter: blur(10px);
      padding: 10px 30px;
      position: fixed;
      width: 100%;
      top: 0;
      left: 0;
      z-index: 10;
      box-shadow: 0 2px 15px rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .nav-container {
      display: flex;
      align-items: center;
      width: 100%;
      max-width: 1100px;
      margin: auto;
      justify-content: space-between;
    }
    .logo-link img {
      height: 40px;
    }
    #nav-toggle {
      display: none;
      flex-direction: column;
      cursor: pointer;
      width: 30px;
      height: 25px;
      justify-content: space-between;
    }
    #nav-toggle span {
      display: block;
      height: 4px;
      background: #bbb;
      border-radius: 2px;
    }
    ul.nav-menu {
      list-style: none;
      display: flex;
      gap: 25px;
      align-items: center;
      font-weight: 600;
    }
    ul.nav-menu li a,
    ul.nav-menu li button {
      color: #eee;
      text-decoration: none;
      font-size: 1rem;
      background: none;
      border: none;
      cursor: pointer;
    }
    ul.nav-menu li button:hover,
    ul.nav-menu li a:hover {
      color: #bb86fc;
    }
    main {
      background: #2a2a4fdd;
      border-radius: 20px;
      padding: 40px 60px;
      max-width: 600px;
      margin: 140px auto 60px auto;
      box-shadow: 0 0 30px rgba(187, 134, 252, 0.8);
      backdrop-filter: blur(12px);
      position: relative;
      z-index: 5;
      text-align: center;
      color: #eee;
    }
    p.timer {
      font-size: 2rem;
      margin-bottom: 20px;
      font-weight: 700;
      text-shadow: 0 0 8px #bb86fcaa;
    }
    p.btc-earned {
      font-size: 1.5rem;
      margin-top: -20px;
      margin-bottom: 40px;
      color: #b5f4a5;
      text-shadow: 0 0 8px #a5f47faa;
      font-weight: 700;
    }

    /* Responsive menu toggle */
    @media (max-width: 768px) {
      #nav-toggle {
        display: flex;
      }
      ul.nav-menu {
        position: fixed;
        top: 60px;
        right: -100%;
        background: #1a1a2e;
        height: calc(100vh - 60px);
        width: 220px;
        flex-direction: column;
        padding: 20px;
        gap: 15px;
        transition: right 0.3s ease;
        box-shadow: -3px 0 15px rgba(0,0,0,0.7);
      }
      ul.nav-menu.active {
        right: 0;
      }
    }

    /* Theme toggle button */
    #theme-toggle {
      font-size: 1.2rem;
      background: none;
      border: none;
      cursor: pointer;
      color: #eee;
      user-select: none;
    }
  </style>
</head>
<body>
  <canvas id="bubble-canvas"></canvas>
  <canvas id="drop-canvas"></canvas>

  <nav class="navbar" role="navigation" aria-label="Main Navigation">
    <div class="nav-container">
      <a href="dashboard.html" class="logo-link" aria-label="Logo CryptoSim">
        <img src="logo.png" alt="CryptoSim Logo" />
      </a>
      <div id="nav-toggle" aria-label="Apri menu" role="button" tabindex="0" aria-expanded="false" aria-controls="nav-menu">
        <span></span><span></span><span></span>
      </div>
      <ul class="nav-menu" id="nav-menu" role="menu">
        <li role="none"><a role="menuitem" href="dashboard.html">Home</a></li>
        <li role="none"><a role="menuitem" href="exchange.html">Exchange</a></li>
        <li role="none"><a role="menuitem" href="vouch-create.html">Vouch Create</a></li>
        <li role="none"><a role="menuitem" href="vouch-redeem.html">Vouch Redeem</a></li>
        <li role="none"><a role="menuitem" href="afk.html">AFK Zone</a></li>
        <li role="none"><a role="menuitem" href="account.html">Account</a></li>
        <li role="none"><button id="theme-toggle" aria-label="Cambia tema">ðŸŒ™</button></li>
      </ul>
    </div>
  </nav>

  <main>
    <h1>AFK Zone</h1>
    <p class="timer" id="countdown">Tempo rimasto: 02:00</p>
    <p class="btc-earned" id="btc-earned">BTC Guadagnati: 0.000</p>
    <p>Clicca sulle gocce che cadono per togliere 5 secondi dal timer e guadagnare BTC!</p>
  </main>

  <script type="module">
    // NAVBAR menu toggle
    const navToggle = document.getElementById('nav-toggle');
    const navMenu = document.getElementById('nav-menu');

    navToggle.addEventListener('click', () => {
      const expanded = navToggle.getAttribute('aria-expanded') === 'true';
      navToggle.setAttribute('aria-expanded', String(!expanded));
      navMenu.classList.toggle('active');
    });

    navToggle.addEventListener('keydown', (e) => {
      if(e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        navToggle.click();
      }
    });

    // Theme toggle (light/dark)
    const themeToggle = document.getElementById('theme-toggle');
    const darkThemeClass = 'dark-theme';

    function applyTheme(isDark) {
      if(isDark) {
        document.body.style.background = '#121212';
        document.body.style.color = '#ddd';
        themeToggle.textContent = 'â˜€ï¸';
      } else {
        document.body.style.background = '#1a1a2e';
        document.body.style.color = '#eee';
        themeToggle.textContent = 'ðŸŒ™';
      }
    }

    // inizialmente tema scuro
    let darkMode = true;
    applyTheme(darkMode);

    themeToggle.addEventListener('click', () => {
      darkMode = !darkMode;
      applyTheme(darkMode);
    });

    // Canvas setup
    const bubbleCanvas = document.getElementById('bubble-canvas');
    const bubbleCtx = bubbleCanvas.getContext('2d');
    const dropCanvas = document.getElementById('drop-canvas');
    const dropCtx = dropCanvas.getContext('2d');
    let width, height;

    function resize() {
      width = window.innerWidth;
      height = window.innerHeight;
      bubbleCanvas.width = width;
      bubbleCanvas.height = height;
      dropCanvas.width = width;
      dropCanvas.height = height;
    }
    window.addEventListener('resize', resize);
    resize();

    // BUBBLES
    class Bubble {
      constructor() {
        this.reset();
      }
      reset() {
        this.x = Math.random() * width;
        this.y = height + Math.random() * 100;
        this.radius = 8 + Math.random() * 12;
        this.speed = 0.5 + Math.random() * 1.5;
        this.alpha = 0.1 + Math.random() * 0.3;
        this.phase = Math.random() * 2 * Math.PI;
      }
      update() {
        this.y -= this.speed;
        this.x += Math.sin(this.phase) * 0.3;
        this.phase += 0.03;
        if (this.y + this.radius < 0) this.reset();
      }
      draw(ctx) {
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.radius, 0, 2 * Math.PI);
        const gradient = ctx.createRadialGradient(this.x, this.y, this.radius * 0.2, this.x, this.y, this.radius);
        gradient.addColorStop(0, `rgba(187,134,252,${this.alpha})`);
        gradient.addColorStop(1, 'rgba(187,134,252,0)');
        ctx.fillStyle = gradient;
        ctx.fill();
      }
    }
    let bubbles = [];
    function initBubbles() {
      bubbles = [];
      for (let i = 0; i < 50; i++) bubbles.push(new Bubble());
    }
    initBubbles();

    // DROPS
    class Drop {
      constructor() {
        this.reset();
        this.clicked = false;
      }
      reset() {
        this.x = Math.random() * width;
        this.y = -10 - Math.random() * 100;
        this.radius = 15 + Math.random() * 10;
        this.speed = 1.5 + Math.random() * 2;
        this.clicked = false;
      }
      update() {
        this.y += this.speed;
      }
      draw(ctx) {
        ctx.beginPath();
        ctx.fillStyle = 'rgba(187,134,252,0.8)';
        ctx.shadowColor = '#bb86fc';
        ctx.shadowBlur = 8;
        ctx.moveTo(this.x, this.y - this.radius);
        ctx.bezierCurveTo(
          this.x + this.radius, this.y - this.radius / 2,
          this.x + this.radius / 2, this.y + this.radius,
          this.x, this.y + this.radius
        );
        ctx.bezierCurveTo(
          this.x - this.radius / 2, this.y + this.radius,
          this.x - this.radius, this.y - this.radius / 2,
          this.x, this.y - this.radius
        );
        ctx.fill();
      }
      isClicked(mx, my) {
        const dx = mx - this.x;
        const dy = my - this.y;
        return dx*dx + dy*dy <= this.radius*this.radius;
      }
    }

    let drops = [];

    // Spawn drops max 10 al minuto (una ogni 6 sec)
    let lastDropSpawnTime = 0;
    const dropInterval = 6000; // ms

    function spawnDrop(time) {
      // Rimuove gocce fuori schermo
      drops = drops.filter(d => d.y - d.radius <= height);

      if (drops.length < 10) {
        drops.push(new Drop());
      }
      lastDropSpawnTime = time;
    }

    // TIMER
    let timerSeconds = 120; // 2 minuti
    let timerRunning = true;
    const countdownEl = document.getElementById('countdown');
    const btcEarnedEl = document.getElementById('btc-earned');
    let btcEarned = 0;

    function updateTimerText() {
      const m = Math.floor(timerSeconds / 60).toString().padStart(2, '0');
      const s = Math.floor(timerSeconds % 60).toString().padStart(2, '0');
      countdownEl.textContent = `Tempo rimasto: ${m}:${s}`;
    }

    function updateBtcText() {
      btcEarnedEl.textContent = `BTC Guadagnati: ${btcEarned.toFixed(3)}`;
    }

    // Blocca timer se scheda non attiva
    document.addEventListener('visibilitychange', () => {
      timerRunning = !document.hidden;
    });

    // Gestione click sulle gocce
    dropCanvas.addEventListener('click', (e) => {
      const rect = dropCanvas.getBoundingClientRect();
      const mx = e.clientX - rect.left;
      const my = e.clientY - rect.top;
      for (const drop of drops) {
        if (!drop.clicked && drop.isClicked(mx, my)) {
          drop.clicked = true;
          timerSeconds = Math.max(0, timerSeconds - 5);
          btcEarned += 0.001;
          updateTimerText();
          updateBtcText();
          drops = drops.filter(d => d !== drop);
          break;
        }
      }
    });

    function animate(time = 0) {
      bubbleCtx.clearRect(0, 0, width, height);
      dropCtx.clearRect(0, 0, width, height);

      for (const b of bubbles) {
        b.update();
        b.draw(bubbleCtx);
      }

      for (const d of drops) {
        d.update();
        d.draw(dropCtx);
      }

      if (!lastDropSpawnTime || time - lastDropSpawnTime > dropInterval) {
        spawnDrop(time);
      }

      if (timerRunning) {
        timerSeconds -= 1/60;
        if (timerSeconds <= 0) {
          timerSeconds = 120; // reset timer
        }
        updateTimerText();
      }

      requestAnimationFrame(animate);
    }

    updateTimerText();
    updateBtcText();
    animate();
  </script>
</body>
</html>
